

#include "disp1color.h"

#if (DISP1COLOR_type == DISPTYPE_ssd1306)
  #include <ssd1306.h>
#else
  #error Р В Р’В Р В Р’В°Р В Р’В±Р В РЎвЂўР РЋРІР‚С™Р В Р’В° c Р В Р вЂ Р РЋРІР‚в„–Р В Р’В±Р РЋР вЂљР В Р’В°Р В Р вЂ¦Р В Р вЂ¦Р РЋРІР‚в„–Р В РЎпїЅ Р РЋРІР‚С™Р В РЎвЂ�Р В РЎвЂ”Р В РЎвЂўР В РЎпїЅ Р В РўвЂ�Р В РЎвЂ�Р РЋР С“Р В РЎвЂ”Р В Р’В»Р В Р’ВµР РЋР РЏ Р В Р вЂ¦Р В Р’Вµ Р В РЎвЂ”Р В РЎвЂўР В РўвЂ�Р В РўвЂ�Р В Р’ВµР РЋР вЂљР В Р’В¶Р В РЎвЂ�Р В Р вЂ Р В Р’В°Р В Р’ВµР РЋРІР‚С™Р РЋР С“Р РЋР РЏ, Р В РЎвЂ”Р В РЎвЂўР В РЎвЂ”Р РЋР вЂљР В РЎвЂўР В Р’В±Р РЋРЎвЂњР В РІвЂћвЂ“Р РЋРІР‚С™Р В Р’Вµ Р В РЎвЂўР В Р’В±Р В Р вЂ¦Р В РЎвЂўР В Р вЂ Р В РЎвЂ�Р РЋРІР‚С™Р РЋР Р‰ Р В РЎпїЅР В РЎвЂўР В РўвЂ�Р РЋРЎвЂњР В Р’В»Р РЋР Р‰ disp1color
#endif

// frame buffer
static uint8_t buff[((DISP1COLOR_Width * DISP1COLOR_Height) / 8) + 1];

//
uint8_t ComArrSet[] = {4, 0, CMD_SetColumnAddr, 0, 0x7F,\
					   4, 0, CMD_SetPageAddr, 0, 0x7, 0};

// Array with commands and data
uint8_t ComArr[]= {2, 0, CMD_Sleep,						3, 0, CMD_SetDisplayClockDivider,0x80, \
				   3, 0, CMD_SetMultiplexRatio,0x3F,	3, 0, CMD_SetDisplayOffset, 0,\
				   2, 0, CMD_SetDisplayStartLine, 		3, 0, CMD_ChargePumpSetting, 0x14,\
				   2, 0, CMD_SetMemAdressingMode,		2, 0, CMD_SetSegmentRemap,\
				   2, 0, CMD_SetCOMoutScanDirection,	3, 0, CMD_SetCOMPinsConfig,0x12,\
				   3, 0, CMD_SetContrast, 127,			3, 0, CMD_SetPrechargePeriod, 0x22, \
				   3, 0, CMD_SetVCOMHDeselectLevel,0x40,2, 0, CMD_AllPixRAM, \
				   2, 0, CMD_SetInverseOff,				2, 0, CMD_DeactivateScroll,\
				   2, 0, CMD_Wake,0 };

uint8_t *ptrCom;

uint8_t *ptrNexCom;
uint16_t Size;

extern I2C_HandleTypeDef hi2c2;

//==============================================================================
// Настройка дисплея
//==============================================================================
void disp1color_Init(void)
{
#if (DISP1COLOR_type == DISPTYPE_ssd1306)
//	Отправляет команды инициализации.
  SSD1306_Init(DISP1COLOR_Width, DISP1COLOR_Height);
  while ((HAL_I2C_GetState(&hi2c2) != HAL_I2C_STATE_READY)){
//	  ждеат пока не отправятся все команды
  }
  //очищает экран
  disp1color_FillScreenbuff(0);
  SSD1306_DisplayFullUpdate(buff, sizeof(buff));
#endif
}

// записывает в буфер кадра значения FillValue
//==============================================================================
void disp1color_FillScreenbuff(uint8_t FillValue)
{
	buff[0] = 0x40;
	for(int i = 1; i != BufLen; i++ )
	{
		buff[i] = FillValue;
	}
//  memset(buff+1, FillValue, sizeof(buff));
}

//==============================================================================
// Р В РЎСџР РЋР вЂљР В РЎвЂўР РЋРІР‚В Р В Р’ВµР В РўвЂ�Р РЋРЎвЂњР РЋР вЂљР В Р’В° Р В Р вЂ Р РЋРІР‚в„–Р В Р вЂ Р В РЎвЂўР В РўвЂ�Р В РЎвЂ�Р РЋРІР‚С™ Р В Р вЂ¦Р В Р’В° Р В РўвЂ�Р В РЎвЂ�Р РЋР С“Р В РЎвЂ”Р В Р’В»Р В Р’ВµР В РІвЂћвЂ“ Р РЋРІР‚С›Р В РЎвЂўР РЋР вЂљР В РЎпїЅР В Р’В°Р РЋРІР‚С™Р В РЎвЂ�Р РЋР вЂљР В РЎвЂўР В Р вЂ Р В Р’В°Р В Р вЂ¦Р В Р вЂ¦Р РЋРЎвЂњР РЋР вЂ№ Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР РЋРЎвЂњ
//==============================================================================
int16_t disp1color_printf(uint8_t X, uint8_t Y, uint8_t FontID, const char *args, ...)
{
  char StrBuff[100];

  va_list ap;
  va_start(ap, args);
  vsnprintf(StrBuff, sizeof(StrBuff), args, ap);
  va_end(ap);

  return disp1color_DrawString(X+1, Y, FontID, (uint8_t *)StrBuff);
}


//==============================================================================
// Р В Р’В¤Р РЋРЎвЂњР В Р вЂ¦Р В РЎвЂќР РЋРІР‚В Р В РЎвЂ�Р РЋР РЏ Р В Р вЂ Р РЋРІР‚в„–Р В Р вЂ Р В РЎвЂўР В РўвЂ�Р В Р’В° Р РЋРІР‚С™Р В Р’ВµР В РЎвЂќР РЋР С“Р РЋРІР‚С™Р В Р’В° Р В РЎвЂ�Р В Р’В· Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР В РЎвЂ� Str Р В Р вЂ¦Р В Р’В° Р В РўвЂ�Р В РЎвЂ�Р РЋР С“Р В РЎвЂ”Р В Р’В»Р В Р’ВµР В РІвЂћвЂ“
//==============================================================================
int16_t disp1color_DrawString(uint8_t X, uint8_t Y, uint8_t FontID, uint8_t *Str)
{
  uint8_t done = 0;             // Р В Р’В¤Р В Р’В»Р В Р’В°Р В РЎвЂ“ Р В РЎвЂўР В РЎвЂќР В РЎвЂўР В Р вЂ¦Р РЋРІР‚РЋР В Р’В°Р В Р вЂ¦Р В РЎвЂ�Р РЋР РЏ Р В Р вЂ Р РЋРІР‚в„–Р В Р вЂ Р В РЎвЂўР В РўвЂ�Р В Р’В°
  uint8_t Xstart = X;           // Р В РІР‚вЂќР В Р’В°Р В РЎвЂ”Р В РЎвЂўР В РЎпїЅР В РЎвЂ�Р В Р вЂ¦Р В Р’В°Р В Р’ВµР В РЎпїЅ Р В РЎвЂќР РЋРЎвЂњР В РўвЂ�Р В Р’В° Р В Р’В±Р РЋРЎвЂњР В РўвЂ�Р В Р’ВµР В РЎпїЅ Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР В Р вЂ Р В РЎвЂўР В РўвЂ�Р В РЎвЂ�Р РЋРІР‚С™Р РЋР Р‰ Р В РЎвЂќР В Р’В°Р РЋР вЂљР В Р’ВµР РЋРІР‚С™Р В РЎвЂќР РЋРЎвЂњ Р В РЎвЂ”Р РЋР вЂљР В РЎвЂ� Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР РЋРІР‚В¦Р В РЎвЂўР В РўвЂ�Р В Р’Вµ Р В Р вЂ¦Р В Р’В° Р В Р вЂ¦Р В РЎвЂўР В Р вЂ Р РЋРЎвЂњР РЋР вЂ№ Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР РЋРЎвЂњ
  uint8_t StrHeight = 8;        // Р В РІР‚в„ўР РЋРІР‚в„–Р РЋР С“Р В РЎвЂўР РЋРІР‚С™Р В Р’В° Р РЋР С“Р В РЎвЂ�Р В РЎпїЅР В Р вЂ Р В РЎвЂўР В Р’В»Р В РЎвЂўР В Р вЂ  Р В Р вЂ  Р В РЎвЂ”Р В РЎвЂ�Р В РЎвЂќР РЋР С“Р В Р’ВµР В Р’В»Р РЋР РЏР РЋРІР‚В¦ Р В РўвЂ�Р В Р’В»Р РЋР РЏ Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР РЋРІР‚В¦Р В РЎвЂўР В РўвЂ�Р В Р’В° Р В Р вЂ¦Р В Р’В° Р РЋР С“Р В Р’В»Р В Р’ВµР В Р’В¶Р РЋРЎвЂњР РЋР вЂ№Р РЋРІР‚В°Р РЋРЎвЂњР РЋР вЂ№ Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР РЋРЎвЂњ

  // Р В РІР‚в„ўР РЋРІР‚в„–Р В Р вЂ Р В РЎвЂўР В РўвЂ� Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР В РЎвЂ�
  while (!done)
  {
    switch (*Str)
    {
    case '\0':  // Р В РЎв„ўР В РЎвЂўР В Р вЂ¦Р В Р’ВµР РЋРІР‚В  Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР В РЎвЂ�
      done = 1;
      break;
    case '\n':  // Р В РЎСџР В Р’ВµР РЋР вЂљР В Р’ВµР РЋРІР‚В¦Р В РЎвЂўР В РўвЂ� Р В Р вЂ¦Р В Р’В° Р РЋР С“Р В Р’В»Р В Р’ВµР В РўвЂ�Р РЋРЎвЂњР РЋР вЂ№Р РЋРІР‚В°Р РЋРЎвЂњР РЋР вЂ№ Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР РЋРЎвЂњ
      Y += StrHeight;
      break;
    case '\r':  // Р В РЎСџР В Р’ВµР РЋР вЂљР В Р’ВµР РЋРІР‚В¦Р В РЎвЂўР В РўвЂ� Р В Р вЂ  Р В Р вЂ¦Р В Р’В°Р РЋРІР‚РЋР В Р’В°Р В Р’В»Р В РЎвЂў Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР В РЎвЂ�
      X = Xstart;
      break;
    default:    // Р В РЎвЂєР РЋРІР‚С™Р В РЎвЂўР В Р’В±Р РЋР вЂљР В Р’В°Р В Р’В¶Р В Р’В°Р В Р’ВµР В РЎпїЅР РЋРІР‚в„–Р В РІвЂћвЂ“ Р РЋР С“Р В РЎвЂ�Р В РЎпїЅР В Р вЂ Р В РЎвЂўР В Р’В»
      X += disp1color_DrawChar(X, Y, FontID, *Str,0);
      StrHeight = font_GetCharHeight(font_GetFontStruct(FontID, *Str));
      break;
    }
    Str++;
  }

  return X;
}
int16_t disp1color_DrawString_Invert(uint8_t X, uint8_t Y, uint8_t FontID, uint8_t *Str)
{
  uint8_t done = 0;             // Р В Р’В¤Р В Р’В»Р В Р’В°Р В РЎвЂ“ Р В РЎвЂўР В РЎвЂќР В РЎвЂўР В Р вЂ¦Р РЋРІР‚РЋР В Р’В°Р В Р вЂ¦Р В РЎвЂ�Р РЋР РЏ Р В Р вЂ Р РЋРІР‚в„–Р В Р вЂ Р В РЎвЂўР В РўвЂ�Р В Р’В°
  uint8_t Xstart = X;           // Р В РІР‚вЂќР В Р’В°Р В РЎвЂ”Р В РЎвЂўР В РЎпїЅР В РЎвЂ�Р В Р вЂ¦Р В Р’В°Р В Р’ВµР В РЎпїЅ Р В РЎвЂќР РЋРЎвЂњР В РўвЂ�Р В Р’В° Р В Р’В±Р РЋРЎвЂњР В РўвЂ�Р В Р’ВµР В РЎпїЅ Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР В Р вЂ Р В РЎвЂўР В РўвЂ�Р В РЎвЂ�Р РЋРІР‚С™Р РЋР Р‰ Р В РЎвЂќР В Р’В°Р РЋР вЂљР В Р’ВµР РЋРІР‚С™Р В РЎвЂќР РЋРЎвЂњ Р В РЎвЂ”Р РЋР вЂљР В РЎвЂ� Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР РЋРІР‚В¦Р В РЎвЂўР В РўвЂ�Р В Р’Вµ Р В Р вЂ¦Р В Р’В° Р В Р вЂ¦Р В РЎвЂўР В Р вЂ Р РЋРЎвЂњР РЋР вЂ№ Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР РЋРЎвЂњ
  uint8_t StrHeight = 8;        // Р В РІР‚в„ўР РЋРІР‚в„–Р РЋР С“Р В РЎвЂўР РЋРІР‚С™Р В Р’В° Р РЋР С“Р В РЎвЂ�Р В РЎпїЅР В Р вЂ Р В РЎвЂўР В Р’В»Р В РЎвЂўР В Р вЂ  Р В Р вЂ  Р В РЎвЂ”Р В РЎвЂ�Р В РЎвЂќР РЋР С“Р В Р’ВµР В Р’В»Р РЋР РЏР РЋРІР‚В¦ Р В РўвЂ�Р В Р’В»Р РЋР РЏ Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР РЋРІР‚В¦Р В РЎвЂўР В РўвЂ�Р В Р’В° Р В Р вЂ¦Р В Р’В° Р РЋР С“Р В Р’В»Р В Р’ВµР В Р’В¶Р РЋРЎвЂњР РЋР вЂ№Р РЋРІР‚В°Р РЋРЎвЂњР РЋР вЂ№ Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР РЋРЎвЂњ
  // Р В РІР‚в„ўР РЋРІР‚в„–Р В Р вЂ Р В РЎвЂўР В РўвЂ� Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР В РЎвЂ�
  while (!done)
  {
    switch (*Str)
    {
    case '\0':  // Р В РЎв„ўР В РЎвЂўР В Р вЂ¦Р В Р’ВµР РЋРІР‚В  Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР В РЎвЂ�
      done = 1;
      break;
    case '\n':  // Р В РЎСџР В Р’ВµР РЋР вЂљР В Р’ВµР РЋРІР‚В¦Р В РЎвЂўР В РўвЂ� Р В Р вЂ¦Р В Р’В° Р РЋР С“Р В Р’В»Р В Р’ВµР В РўвЂ�Р РЋРЎвЂњР РЋР вЂ№Р РЋРІР‚В°Р РЋРЎвЂњР РЋР вЂ№ Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР РЋРЎвЂњ
      Y += StrHeight;
      break;
    case '\r':  // Р В РЎСџР В Р’ВµР РЋР вЂљР В Р’ВµР РЋРІР‚В¦Р В РЎвЂўР В РўвЂ� Р В Р вЂ  Р В Р вЂ¦Р В Р’В°Р РЋРІР‚РЋР В Р’В°Р В Р’В»Р В РЎвЂў Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР В РЎвЂ�
      X = Xstart;
      break;
    default:    // Р В РЎвЂєР РЋРІР‚С™Р В РЎвЂўР В Р’В±Р РЋР вЂљР В Р’В°Р В Р’В¶Р В Р’В°Р В Р’ВµР В РЎпїЅР РЋРІР‚в„–Р В РІвЂћвЂ“ Р РЋР С“Р В РЎвЂ�Р В РЎпїЅР В Р вЂ Р В РЎвЂўР В Р’В»
      X += disp1color_DrawChar(X, Y, FontID, *Str, 1);
      StrHeight = font_GetCharHeight(font_GetFontStruct(FontID, *Str));
      break;
    }
    Str++;
  }

  return X;
}


//==============================================================================
// Р В Р’В¤Р РЋРЎвЂњР В Р вЂ¦Р В РЎвЂќР РЋРІР‚В Р В РЎвЂ�Р РЋР РЏ Р В Р вЂ Р РЋРІР‚в„–Р В Р вЂ Р В РЎвЂўР В РўвЂ�Р В Р’В° Р РЋР С“Р В РЎвЂ�Р В РЎпїЅР В Р вЂ Р В РЎвЂўР В Р’В»Р В Р’В° Char Р В Р вЂ¦Р В Р’В° Р В РўвЂ�Р В РЎвЂ�Р РЋР С“Р В РЎвЂ”Р В Р’В»Р В Р’ВµР В РІвЂћвЂ“. Р В РІР‚в„ўР В РЎвЂўР В Р’В·Р В Р вЂ Р РЋР вЂљР В Р’В°Р РЋРІР‚В°Р В Р’В°Р В Р’ВµР РЋРІР‚С™ Р РЋРІвЂљВ¬Р В РЎвЂ�Р РЋР вЂљР В РЎвЂ�Р В Р вЂ¦Р РЋРЎвЂњ Р В Р вЂ Р РЋРІР‚в„–Р В Р вЂ Р В Р’ВµР В РўвЂ�Р В Р’ВµР В Р вЂ¦Р В Р вЂ¦Р В РЎвЂўР В РЎвЂ“Р В РЎвЂў Р РЋР С“Р В РЎвЂ�Р В РЎпїЅР В Р вЂ Р В РЎвЂўР В Р’В»Р В Р’В°
//==============================================================================
uint8_t disp1color_DrawChar(uint8_t X, uint8_t Y, uint8_t FontID, uint8_t Char, uint8_t Invert)
{
  // Р В Р в‚¬Р В РЎвЂќР В Р’В°Р В Р’В·Р В Р’В°Р РЋРІР‚С™Р В Р’ВµР В Р’В»Р РЋР Р‰ Р В Р вЂ¦Р В Р’В° Р В РЎвЂ”Р В РЎвЂўР В РўвЂ�Р РЋРІР‚С™Р В Р’В°Р В Р’В±Р В Р’В»Р В РЎвЂ�Р РЋРІР‚РЋР В РЎвЂќР РЋРЎвЂњ Р В РЎвЂќР В РЎвЂўР В Р вЂ¦Р В РЎвЂќР РЋР вЂљР В Р’ВµР РЋРІР‚С™Р В Р вЂ¦Р В РЎвЂўР В РЎвЂ“Р В РЎвЂў Р РЋР С“Р В РЎвЂ�Р В РЎпїЅР В Р вЂ Р В РЎвЂўР В Р’В»Р В Р’В° Р РЋРІвЂљВ¬Р РЋР вЂљР В РЎвЂ�Р РЋРІР‚С›Р РЋРІР‚С™Р В Р’В°
  uint8_t *pCharTable = font_GetFontStruct(FontID, Char);
  uint8_t CharWidth = font_GetCharWidth(pCharTable);    // Р В Р РѓР В РЎвЂ�Р РЋР вЂљР В РЎвЂ�Р В Р вЂ¦Р В Р’В° Р РЋР С“Р В РЎвЂ�Р В РЎпїЅР В Р вЂ Р В РЎвЂўР В Р’В»Р В Р’В°
  uint8_t CharHeight = font_GetCharHeight(pCharTable);  // Р В РІР‚в„ўР РЋРІР‚в„–Р РЋР С“Р В РЎвЂўР РЋРІР‚С™Р В Р’В° Р РЋР С“Р В РЎвЂ�Р В РЎпїЅР В Р вЂ Р В РЎвЂўР В Р’В»Р В Р’В°
  pCharTable += 2;

  if (FontID == FONTID_6X8M)
  {
    for (uint8_t row = 0; row < CharHeight; row++)
    {
      for (uint8_t col = 0; col < CharWidth; col++)
    	  if(Invert==1)
    		  disp1color_DrawPixel_Invert(X + col, Y + row, pCharTable[row] & (1 << (7 - col)));
    	  else
    		  disp1color_DrawPixel(X + col, Y + row, pCharTable[row] & (1 << (7 - col)));
    }
  }
  else
  {
    for (uint8_t row = 0; row < CharHeight; row++)
    {
      for (uint8_t col = 0; col < CharWidth; col++)
      {
        if (col < 8)
        {
        	if(Invert==1)
        		disp1color_DrawPixel_Invert(X + col, Y + row, pCharTable[row * 2] & (1 << (7 - col)));
        	else
        		disp1color_DrawPixel(X + col, Y + row, pCharTable[row * 2] & (1 << (7 - col)));
        }
        else{
        	if(Invert==1)
        		disp1color_DrawPixel_Invert(X + col, Y + row, pCharTable[(row * 2) + 1] & (1 << (15 - col)));
        	else
        		disp1color_DrawPixel(X + col, Y + row, pCharTable[(row * 2) + 1] & (1 << (15 - col)));
        }

      }
    }
  }

  return CharWidth;
}
//==============================================================================
// Р В РЎСџР РЋР вЂљР В РЎвЂўР РЋРІР‚В Р В Р’ВµР В РўвЂ�Р РЋРЎвЂњР РЋР вЂљР В Р’В° Р РЋРЎвЂњР РЋР С“Р РЋРІР‚С™Р В Р’В°Р В Р вЂ¦Р В Р’В°Р В Р вЂ Р В Р’В»Р В РЎвЂ�Р В Р вЂ Р В Р’В°Р В Р’ВµР РЋРІР‚С™ Р РЋР С“Р В РЎвЂўР РЋР С“Р РЋРІР‚С™Р В РЎвЂўР РЋР РЏР В Р вЂ¦Р В РЎвЂ�Р В Р’Вµ 1 Р В РЎвЂ”Р В РЎвЂ�Р В РЎвЂќР РЋР С“Р В Р’ВµР В Р’В»Р РЋР РЏ Р В РўвЂ�Р В РЎвЂ�Р РЋР С“Р В РЎвЂ”Р В Р’В»Р В Р’ВµР РЋР РЏ
//==============================================================================
void disp1color_DrawPixel(uint8_t X, uint8_t Y, uint8_t State)
{
  // Р В РЎСџР РЋР вЂљР В РЎвЂўР В Р вЂ Р В Р’ВµР РЋР вЂљР РЋР РЏР В Р’ВµР В РЎпїЅ, Р В Р вЂ¦Р В Р’В°Р РЋРІР‚В¦Р В РЎвЂўР В РўвЂ�Р В РЎвЂ�Р РЋРІР‚С™Р РЋР С“Р РЋР РЏ Р В Р’В»Р В РЎвЂ� Р РЋРІР‚С™Р В РЎвЂўР РЋРІР‚РЋР В РЎвЂќР В Р’В° Р В Р вЂ  Р В РЎвЂ”Р В РЎвЂўР В Р’В»Р В Р’Вµ Р В РЎвЂўР РЋРІР‚С™Р РЋР вЂљР В РЎвЂ�Р РЋР С“Р В РЎвЂўР В Р вЂ Р В РЎвЂќР В РЎвЂ� Р В РўвЂ�Р В РЎвЂ�Р РЋР С“Р В РЎвЂ”Р В Р’В»Р В Р’ВµР РЋР РЏ
  if ((X >= DISP1COLOR_Width) || (Y >= DISP1COLOR_Height))
    return;

  uint16_t ByteIdx = Y >> 3;
  uint8_t BitIdx = Y - (ByteIdx << 3); // Р В РІР‚в„ўР РЋРІР‚в„–Р РЋР С“Р В РЎвЂўР РЋРІР‚С™Р В Р’В° Р В РЎвЂўР РЋРІР‚С™Р В Р вЂ¦Р В РЎвЂўР РЋР С“Р В РЎвЂ�Р РЋРІР‚С™Р В Р’ВµР В Р’В»Р РЋР Р‰Р В Р вЂ¦Р В РЎвЂў Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР В РЎвЂ� Р В Р’В±Р В Р’В°Р В РІвЂћвЂ“Р РЋРІР‚С™ (0<=Y<=7)
  ByteIdx *= DISP1COLOR_Width;
  ByteIdx += X;

  if (State)
    buff[ByteIdx] |= (1 << BitIdx);
  else
    buff[ByteIdx] &= ~(1 << BitIdx);
}

void disp1color_DrawPixel_Invert(uint8_t X, uint8_t Y, uint8_t State)
{
  // Р В РЎСџР РЋР вЂљР В РЎвЂўР В Р вЂ Р В Р’ВµР РЋР вЂљР РЋР РЏР В Р’ВµР В РЎпїЅ, Р В Р вЂ¦Р В Р’В°Р РЋРІР‚В¦Р В РЎвЂўР В РўвЂ�Р В РЎвЂ�Р РЋРІР‚С™Р РЋР С“Р РЋР РЏ Р В Р’В»Р В РЎвЂ� Р РЋРІР‚С™Р В РЎвЂўР РЋРІР‚РЋР В РЎвЂќР В Р’В° Р В Р вЂ  Р В РЎвЂ”Р В РЎвЂўР В Р’В»Р В Р’Вµ Р В РЎвЂўР РЋРІР‚С™Р РЋР вЂљР В РЎвЂ�Р РЋР С“Р В РЎвЂўР В Р вЂ Р В РЎвЂќР В РЎвЂ� Р В РўвЂ�Р В РЎвЂ�Р РЋР С“Р В РЎвЂ”Р В Р’В»Р В Р’ВµР РЋР РЏ
  if ((X >= DISP1COLOR_Width) || (Y >= DISP1COLOR_Height))
    return;

  uint16_t ByteIdx = Y >> 3;
  uint8_t BitIdx = Y - (ByteIdx << 3); // Р В РІР‚в„ўР РЋРІР‚в„–Р РЋР С“Р В РЎвЂўР РЋРІР‚С™Р В Р’В° Р В РЎвЂўР РЋРІР‚С™Р В Р вЂ¦Р В РЎвЂўР РЋР С“Р В РЎвЂ�Р РЋРІР‚С™Р В Р’ВµР В Р’В»Р РЋР Р‰Р В Р вЂ¦Р В РЎвЂў Р РЋР С“Р РЋРІР‚С™Р РЋР вЂљР В РЎвЂўР В РЎвЂќР В РЎвЂ� Р В Р’В±Р В Р’В°Р В РІвЂћвЂ“Р РЋРІР‚С™ (0<=Y<=7)
  ByteIdx *= DISP1COLOR_Width;
  ByteIdx += X;

  if (State)
	  buff[ByteIdx] = ((buff[ByteIdx] ^ (1 << BitIdx)) & (~(1 << BitIdx)));
  else
	  buff[ByteIdx] |= (1 << BitIdx);
}

//==============================================================================
// Р В РЎСџР РЋР вЂљР В РЎвЂўР РЋРІР‚В Р В Р’ВµР В РўвЂ�Р РЋРЎвЂњР РЋР вЂљР В Р’В° Р В РЎвЂўР В Р’В±Р В Р вЂ¦Р В РЎвЂўР В Р вЂ Р В Р’В»Р РЋР РЏР В Р’ВµР РЋРІР‚С™ Р РЋР С“Р В РЎвЂўР РЋР С“Р РЋРІР‚С™Р В РЎвЂўР РЋР РЏР В Р вЂ¦Р В РЎвЂ�Р В Р’Вµ Р В РЎвЂ�Р В Р вЂ¦Р В РўвЂ�Р В РЎвЂ�Р В РЎвЂќР В Р’В°Р РЋРІР‚С™Р В РЎвЂўР РЋР вЂљР В РЎвЂўР В Р вЂ  Р В Р вЂ  Р РЋР С“Р В РЎвЂўР В РЎвЂўР РЋРІР‚С™Р В Р вЂ Р В Р’ВµР РЋРІР‚С™Р РЋР С“Р РЋРІР‚С™Р В Р вЂ Р В РЎвЂ�Р В РЎвЂ� Р РЋР С“ Р В Р’В±Р РЋРЎвЂњР РЋРІР‚С›Р В Р’ВµР РЋР вЂљР В РЎвЂўР В РЎпїЅ Р В РЎвЂќР В Р’В°Р В РўвЂ�Р РЋР вЂљР В Р’В° disp1color_buff
//==============================================================================

void disp1color_UpdateFromBuff(void){
	SSD1306_DisplayFullUpdate(buff, sizeof(buff));
}

void HAL_I2C_MasterTxCpltCallback(I2C_HandleTypeDef *hi2c){
	uint16_t OldSize;
	if((HAL_I2C_GetState(&hi2c2) == HAL_I2C_STATE_READY) && (Size!=0)){
		do
		{
			OldSize = Size;
			Size=0;
			if(HAL_I2C_Master_Transmit_IT(&hi2c2, (uint16_t)I2C_ADDRESS, (uint8_t*)ptrCom, OldSize)!=HAL_OK){
			Error_Handler();
			}
			else {
				while ((HAL_I2C_GetState(&hi2c2) != HAL_I2C_STATE_READY)){
				}
				if((*ptrNexCom) !=0){ // Р В РІР‚СћР РЋР С“Р РЋРІР‚С™Р РЋР Р‰ Р В Р’В»Р В РЎвЂ� Р В Р’ВµР РЋРІР‚В°Р В Р’Вµ Р В РЎвЂќР В РЎвЂўР В РЎпїЅР В Р’В°Р В Р вЂ¦Р В РўвЂ�Р РЋРІР‚в„– Р В РўвЂ�Р В Р’В»Р РЋР РЏ Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР В РўвЂ�Р В Р’В°Р РЋРІР‚РЋР В РЎвЂ�
					ptrCom = ++ptrNexCom; // ptrNexCom Р РЋРІР‚С™Р В Р’ВµР В РЎвЂ”Р В Р’ВµР РЋР вЂљР РЋР Р‰ Р РЋРЎвЂњР В РЎвЂќР В Р’В°Р В Р’В·Р РЋРІР‚в„–Р В Р вЂ Р В Р’В°Р В Р’ВµР РЋРІР‚С™ Р В Р вЂ¦Р В Р’В° Р РЋР С“Р В Р’В»Р В Р’ВµР В РўвЂ�Р РЋРЎвЂњР РЋР вЂ№Р РЋРІР‚В°Р В РЎвЂ�Р В РІвЂћвЂ“ Р РЋР РЉР В Р’В»Р В Р’ВµР В РЎпїЅР В Р’ВµР В Р вЂ¦Р РЋРІР‚С™ Р В РЎпїЅР В Р’В°Р РЋР С“Р РЋР С“Р В РЎвЂ�Р В Р вЂ Р В Р’В°
					Size = *(ptrCom-1);// Р В РЎСџР В РЎвЂўР В Р’В»Р РЋРЎвЂњР РЋРІР‚РЋР В Р’В°Р В Р’ВµР В РЎпїЅ Р В РЎвЂќР В РЎвЂўР В Р’В»Р В РЎвЂ�Р РЋРІР‚РЋР В Р’ВµР РЋР С“Р РЋРІР‚С™Р В Р вЂ Р В РЎвЂў Р В Р’В±Р В Р’В°Р В РІвЂћвЂ“Р РЋРІР‚С™ Р В Р вЂ¦Р В Р’ВµР В РЎвЂўР В Р’В±Р РЋРІР‚В¦Р В РЎвЂўР В РўвЂ�Р В РЎвЂ�Р В РЎпїЅР РЋРІР‚в„–Р РЋРІР‚В¦ Р В РўвЂ�Р В Р’В»Р РЋР РЏ Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР В РўвЂ�Р В Р’В°Р РЋРІР‚РЋР В РЎвЂ�
					ptrNexCom+= Size; //ptrNexCom Р РЋРІР‚С™Р В Р’ВµР В РЎвЂ”Р В Р’ВµР РЋР вЂљР РЋР Р‰ Р РЋРЎвЂњР В РЎвЂќР В Р’В°Р В Р’В·Р РЋРІР‚в„–Р В Р вЂ Р В Р’В°Р В Р’ВµР РЋРІР‚С™ Р В Р вЂ¦Р В Р’В° Р РЋР РЉР В Р’В»Р В Р’ВµР В РЎпїЅР В Р’ВµР В Р вЂ¦Р РЋРІР‚С™ N (Р РЋР С“Р В РЎвЂўР В РўвЂ�Р В Р’ВµР РЋР вЂљР В Р’В¶Р В РЎвЂ�Р РЋРІР‚С™ Р В РЎвЂќР В РЎвЂўР В Р’В»Р В РЎвЂ�Р РЋРІР‚РЋР В Р’ВµР РЋР С“Р РЋРІР‚С™Р В Р вЂ Р В РЎвЂў Р В Р’В±Р В Р’В°Р В РІвЂћвЂ“Р РЋРІР‚С™
					//Р В РўвЂ�Р В Р’В»Р РЋР РЏ Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР В РўвЂ�Р В Р’В°Р РЋРІР‚РЋР В РЎвЂ� Р РЋР С“Р В Р’В»Р В Р’ВµР В РўвЂ�Р РЋРЎвЂњР РЋР вЂ№Р РЋРІР‚В°Р В Р’ВµР В РІвЂћвЂ“ Р В РЎвЂќР В РЎвЂўР В РЎпїЅР В Р’В°Р В Р вЂ¦Р В РўвЂ�Р РЋРІР‚в„–
				}
				else { // Р В Р’ВµР РЋР С“Р В Р’В»Р В РЎвЂ� Р В Р вЂ¦Р В Р’ВµР РЋРІР‚С™ Р В РЎвЂќР В РЎвЂўР В РЎпїЅР В Р’В°Р В Р вЂ¦Р В РўвЂ� Р В Р вЂ Р РЋРІР‚в„–Р РЋРІР‚В¦Р В РЎвЂўР В РўвЂ� Р В РЎвЂ�Р В Р’В· Р РЋРІР‚В Р В РЎвЂ�Р В РЎвЂќР В Р’В»Р В Р’В° Р В РЎвЂ� Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР В РўвЂ�Р В Р’В°Р РЋРІР‚РЋР В Р’В° Р В Р’В·Р В Р’В°Р В РЎвЂќР В Р’В°Р В Р вЂ¦Р РЋРІР‚РЋР В РЎвЂ�Р В Р вЂ Р В Р’В°Р В Р’ВµР РЋРІР‚С™Р РЋР С“Р РЋР РЏ
					Size=0;
				}
			}
		}
		while(Size!=0);
	}
	else{
		Size=0;
		return;
	}
}
